<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Kubernetes Ingress（2）Controller源码分析 | shareinto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="经过上一篇文章的介绍，我们简单了解了整个Ingress的运行机制，这里我们将通过Ingress Controller的源码来更深入分析其运行过程。要了解本文的内容我们要先了解一个概念，就是kuberentes的events events关于events的概念，kubernetes中文社区有一个系列文章剖析得很清析  Kubernetes Events介绍（上） Kubernetes Events介">
<meta name="keywords" content="linux,docker,kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes Ingress（2）Controller源码分析">
<meta property="og:url" content="http://yoursite.com/2017/04/13/KubernetesIngress（2）/index.html">
<meta property="og:site_name" content="shareinto">
<meta property="og:description" content="经过上一篇文章的介绍，我们简单了解了整个Ingress的运行机制，这里我们将通过Ingress Controller的源码来更深入分析其运行过程。要了解本文的内容我们要先了解一个概念，就是kuberentes的events events关于events的概念，kubernetes中文社区有一个系列文章剖析得很清析  Kubernetes Events介绍（上） Kubernetes Events介">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-17T06:24:56.700Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes Ingress（2）Controller源码分析">
<meta name="twitter:description" content="经过上一篇文章的介绍，我们简单了解了整个Ingress的运行机制，这里我们将通过Ingress Controller的源码来更深入分析其运行过程。要了解本文的内容我们要先了解一个概念，就是kuberentes的events events关于events的概念，kubernetes中文社区有一个系列文章剖析得很清析  Kubernetes Events介绍（上） Kubernetes Events介">
  
    <link rel="alternative" href="/atom.xml" title="shareinto" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xlovv.com1.z0.glb.clouddn.com/litten.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Dockerfun</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/centos/" style="font-size: 17.5px;">centos</a> <a href="/tags/cpu/" style="font-size: 10px;">cpu</a> <a href="/tags/docker/" style="font-size: 20px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/git-flow/" style="font-size: 10px;">git-flow</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/ios/" style="font-size: 10px;">ios</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/kernel/" style="font-size: 12.5px;">kernel</a> <a href="/tags/kubernetes/" style="font-size: 17.5px;">kubernetes</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/tool/" style="font-size: 10px;">tool</a> <a href="/tags/操作系统/" style="font-size: 17.5px;">操作系统</a> <a href="/tags/效率/" style="font-size: 10px;">效率</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">虽然不知道你在说什么，但是感觉好厉害的样子...</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Dockerfun</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7xlovv.com1.z0.glb.clouddn.com/litten.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Dockerfun</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-KubernetesIngress（2）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/04/13/KubernetesIngress（2）/" class="article-date">
  	<time datetime="2017-04-13T12:48:38.000Z" itemprop="datePublished">2017-04-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Kubernetes Ingress（2）Controller源码分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/kubernetes/">kubernetes</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>经过上一篇文章的介绍，我们简单了解了整个Ingress的运行机制，这里我们将通过Ingress Controller的源码来更深入分析其运行过程。<br>要了解本文的内容我们要先了解一个概念，就是kuberentes的events</p>
<h1 id="events"><a href="#events" class="headerlink" title="events"></a>events</h1><p>关于events的概念，kubernetes中文社区有一个系列文章剖析得很清析</p>
<ul>
<li><a href="https://www.kubernetes.org.cn/1031.html" target="_blank" rel="noopener">Kubernetes Events介绍（上）</a></li>
<li><a href="https://www.kubernetes.org.cn/1090.html" target="_blank" rel="noopener">Kubernetes Events介绍（中）</a></li>
<li><a href="https://www.kubernetes.org.cn/1195.html" target="_blank" rel="noopener">Kubernetes Events介绍（下）</a></li>
</ul>
<p>文章详细介绍了Events的概念，从哪里产生以及去向哪里等，以及更复杂的Events聚合操作。事实上，kubernetes正是通过Events让Ingress Controller知道资源的变化情况。</p>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><p>从官方提供的一个Ingress Controller简单实现的示例中，我们可以找到整个框架代码的入口<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dc := newDummyController()</span><br><span class="line">	ic := controller.NewIngressController(dc)</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"Shutting down ingress controller..."</span>)</span><br><span class="line">		ic.Stop()</span><br><span class="line">	&#125;()</span><br><span class="line">	ic.Start()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>main函数的工作内容十分简单，就是实例化一个IngressContrller并将其Start起来。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"k8s.io/ingress/core/pkg/ingress/controller"</span></span><br></pre></td></tr></table></figure></p>
<p>这是controller框架核心所在的包<br>我们看一下NewIngressController的定义<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIngressController</span><span class="params">(backend ingress.Controller)</span> *<span class="title">GenericController</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法接收一个ingress.Controller接口，并返回一个GenericController结构体的指针<br>再来看一下ingress.Controller接口的定义<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Controller <span class="keyword">interface</span> &#123;</span><br><span class="line">	healthz.HealthzChecker</span><br><span class="line">	Reload(data []<span class="keyword">byte</span>) ([]<span class="keyword">byte</span>, <span class="keyword">bool</span>, error)</span><br><span class="line">	OnUpdate(Configuration) ([]<span class="keyword">byte</span>, error)</span><br><span class="line">	SetConfig(*api.ConfigMap)</span><br><span class="line">	SetListers(StoreLister)</span><br><span class="line">	BackendDefaults() defaults.Backend</span><br><span class="line">	Info() *BackendInfo</span><br><span class="line">	OverrideFlags(*pflag.FlagSet)</span><br><span class="line">	DefaultIngressClass() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个接口就是ingress controller留给用户自已实现代码的地方，只要实现了这个接口，那么你自定义的ingress controller也就完成了。这里先点一下最重要的两个方法 OnUpdate和Reload<br>当资源发生变化时，框架会调用OnUpdate方法，并将资源配置信息传入，用户根据这些配置信息生成配置（以[]byte返回），然后框架再调用Reload方法，用户在这个方法中可以重新加载配置(例如 nginx -r reload) 嘿嘿是不是一个很典型的模板方法！！</p>
<p>NewIngressController的主要工作是初始化命令行参数，接着在方法最后调用包内私有函数newIngressController</p>
<h2 id="newIngressController"><a href="#newIngressController" class="headerlink" title="newIngressController"></a>newIngressController</h2><p>这个包内方法是整个框架核心所在，它真正的初始化了IngressController<br>来看函数定义：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newIngressController</span><span class="params">(config *Configuration)</span> *<span class="title">GenericController</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的Configuration包含了从命令行传进来的参数配置，以及用户实现的一个Controller接口<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Configuration <span class="keyword">struct</span> &#123;</span><br><span class="line">	Client clientset.Interface</span><br><span class="line">	ResyncPeriod   time.Duration</span><br><span class="line">	DefaultService <span class="keyword">string</span></span><br><span class="line">	IngressClass   <span class="keyword">string</span></span><br><span class="line">	Namespace      <span class="keyword">string</span></span><br><span class="line">	ConfigMapName  <span class="keyword">string</span></span><br><span class="line">	TCPConfigMapName <span class="keyword">string</span></span><br><span class="line">	UDPConfigMapName      <span class="keyword">string</span></span><br><span class="line">	DefaultSSLCertificate <span class="keyword">string</span></span><br><span class="line">	DefaultHealthzURL     <span class="keyword">string</span></span><br><span class="line">	DefaultIngressClass   <span class="keyword">string</span></span><br><span class="line">	PublishService <span class="keyword">string</span></span><br><span class="line">    <span class="comment">//用户实现的接口</span></span><br><span class="line">	Backend ingress.Controller</span><br><span class="line">	UpdateStatus <span class="keyword">bool</span></span><br><span class="line">	ElectionID   <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的Backed就是上文提到的Controller接口，接下来看一下该方法做了哪些事情<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">eventBroadcaster := record.NewBroadcaster()</span><br><span class="line">eventBroadcaster.StartLogging(glog.Infof)</span><br><span class="line">eventBroadcaster.StartRecordingToSink(&amp;unversionedcore.EventSinkImpl&#123;</span><br><span class="line">    Interface: config.Client.Core().Events(config.Namespace),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ic := GenericController&#123;</span><br><span class="line">    cfg:             config,</span><br><span class="line">    stopLock:        &amp;sync.Mutex&#123;&#125;,</span><br><span class="line">    stopCh:          <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">    syncRateLimiter: flowcontrol.NewTokenBucketRateLimiter(<span class="number">0.1</span>, <span class="number">1</span>),</span><br><span class="line">    recorder: eventBroadcaster.NewRecorder(api.EventSource&#123;</span><br><span class="line">        Component: <span class="string">"ingress-controller"</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    sslCertTracker: newSSLCertTracker(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ic.syncQueue = task.NewTaskQueue(ic.sync)</span><br><span class="line">ic.secretQueue = task.NewTaskQueue(ic.syncSecret)</span><br></pre></td></tr></table></figure></p>
<p>这段代码做了三件事情：<br>1.初始化了一个事件广播器<br>2.初始化了GenericController，将前面的配置传过去，并且new了一个事件的recorder，这个recorder用来在后面产生事件。<br>3.初始化了syncQueue和secretQueue</p>
<p>这两个Queue有什么作用呢?来看一下它的定义和注释:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewTaskQueue creates a new task queue with the given sync function.</span></span><br><span class="line"><span class="comment">// The sync function is called for every element inserted into the queue.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTaskQueue</span><span class="params">(syncFn <span class="keyword">func</span>(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>) *<span class="title">Queue</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> NewCustomTaskQueue(syncFn, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注释已经解释得很清楚了，这个方法所创建的queue，每接收一个元素就会调用一个syncFn，并将该元素作为该方法的参数传进去。可以看到ic.syncQueue和ic.secretQueue对应的处理方法为ic.sync和ic.syncSecret，这两个方法到底做了些什么事情，我们后面再分析。<br>这里还有一个问题就是为什么不直接调用syncFn而要通过队列呢，很显然这里队列的作用就是将并行的事情串行化掉而已。</p>
<h2 id="kubernetes客户端的资源监听机制"><a href="#kubernetes客户端的资源监听机制" class="headerlink" title="kubernetes客户端的资源监听机制"></a>kubernetes客户端的资源监听机制</h2><p>kubernetes的资源监听机制是一个相对比较复杂的过程，首先来看一下这段定义<br>在 “k8s.io/kubernetes/pkg/client/cache” 包下面存在着<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResourceEventHandlerFuncs <span class="keyword">struct</span> &#123;</span><br><span class="line">	AddFunc    <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="function">	<span class="title">UpdateFunc</span> <span class="title">func</span><span class="params">(oldObj, newObj <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="function">	<span class="title">DeleteFunc</span> <span class="title">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>这样一样结构体，该结构体实现了以下接口<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResourceEventHandler <span class="keyword">interface</span> &#123;</span><br><span class="line">	OnAdd(obj <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	OnUpdate(oldObj, newObj <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	OnDelete(obj <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r ResourceEventHandlerFuncs)</span> <span class="title">OnAdd</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.AddFunc != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.AddFunc(obj)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r ResourceEventHandlerFuncs)</span> <span class="title">OnUpdate</span><span class="params">(oldObj, newObj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.UpdateFunc != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.UpdateFunc(oldObj, newObj)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r ResourceEventHandlerFuncs)</span> <span class="title">OnDelete</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.DeleteFunc != <span class="literal">nil</span> &#123;</span><br><span class="line">		r.DeleteFunc(obj)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着再来看一下NewInformer函数<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewInformer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	lw ListerWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">	objType runtime.Object,</span></span></span><br><span class="line"><span class="function"><span class="params">	resyncPeriod time.Duration,</span></span></span><br><span class="line"><span class="function"><span class="params">	h ResourceEventHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(Store, *Controller)</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数初始化一个消息通知器，ListerWatcher指定了监听资源的方法，一旦资源发生了变化（增、删、改），就会触发ResourceEventHandler相应的函数。这里是一个观察者模式的简化版，将多播委托简化成单播委托，并且将多个事件聚合在了一起。好了，这里要说一下整个controller最重要的list和watch模型。</p>
<h2 id="List和Watch"><a href="#List和Watch" class="headerlink" title="List和Watch"></a>List和Watch</h2><p>我们先来看一下这段代码：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ic.ingLister.Store, ic.ingController = cache.NewInformer(</span><br><span class="line">		cache.NewListWatchFromClient(ic.cfg.Client.Extensions().RESTClient(), <span class="string">"ingresses"</span>, ic.cfg.Namespace, fields.Everything()),</span><br><span class="line">		&amp;extensions.Ingress&#123;&#125;, ic.cfg.ResyncPeriod, ingEventHandler)</span><br></pre></td></tr></table></figure></p>
<p>顺藤摸瓜：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewListWatchFromClient</span><span class="params">(c Getter, resource <span class="keyword">string</span>, namespace <span class="keyword">string</span>, fieldSelector fields.Selector)</span> *<span class="title">ListWatch</span></span> &#123;</span><br><span class="line">	listFunc := <span class="function"><span class="keyword">func</span><span class="params">(options api.ListOptions)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> c.Get().</span><br><span class="line">			Namespace(namespace).</span><br><span class="line">			Resource(resource).</span><br><span class="line">			VersionedParams(&amp;options, api.ParameterCodec).</span><br><span class="line">			FieldsSelectorParam(fieldSelector).</span><br><span class="line">			Do().</span><br><span class="line">			Get()</span><br><span class="line">	&#125;</span><br><span class="line">	watchFunc := <span class="function"><span class="keyword">func</span><span class="params">(options api.ListOptions)</span> <span class="params">(watch.Interface, error)</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> c.Get().</span><br><span class="line">			Prefix(<span class="string">"watch"</span>).</span><br><span class="line">			Namespace(namespace).</span><br><span class="line">			Resource(resource).</span><br><span class="line">			VersionedParams(&amp;options, api.ParameterCodec).</span><br><span class="line">			FieldsSelectorParam(fieldSelector).</span><br><span class="line">			Watch()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;ListWatch&#123;ListFunc: listFunc, WatchFunc: watchFunc&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里我们找到了controller如何和apiserver交互的代码，既然找到了，那我们就动起手来，看看它具体干了一些什么事睛。</p>
<h3 id="list"><a href="#list" class="headerlink" title="list"></a>list</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createApiserverClient</span><span class="params">(apiserverHost <span class="keyword">string</span>, kubeConfig <span class="keyword">string</span>)</span> <span class="params">(*client.Clientset, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	clientConfig := clientcmd.NewNonInteractiveDeferredLoadingClientConfig(</span><br><span class="line">		&amp;clientcmd.ClientConfigLoadingRules&#123;ExplicitPath: kubeConfig&#125;,</span><br><span class="line">		&amp;clientcmd.ConfigOverrides&#123;ClusterInfo: clientcmdapi.Cluster&#123;Server: apiserverHost&#125;&#125;)</span><br><span class="line"></span><br><span class="line">	cfg, err := clientConfig.ClientConfig()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cfg.QPS = defaultQPS</span><br><span class="line">	cfg.Burst = defaultBurst</span><br><span class="line">	cfg.ContentType = <span class="string">"application/vnd.kubernetes.protobuf"</span></span><br><span class="line">	proxy := <span class="function"><span class="keyword">func</span><span class="params">(_ *http.Request)</span> <span class="params">(*url.URL, error)</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> url.Parse(<span class="string">"http://127.0.0.1:8888"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	cfg.Transport = &amp;http.Transport&#123;Proxy: proxy&#125;</span><br><span class="line"></span><br><span class="line">	glog.Infof(<span class="string">"Creating API server client for %s"</span>, cfg.Host)</span><br><span class="line"></span><br><span class="line">	client, err := client.NewForConfig(cfg)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> client, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kubeClient, err := createApiserverClient(*apiserverHost, *kubeConfigFile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">list, err := kubeClient.Extensions().RESTClient().</span><br><span class="line">	Get().</span><br><span class="line">	Namespace(<span class="string">"default"</span>).</span><br><span class="line">	Resource(<span class="string">"ingresses"</span>).</span><br><span class="line">	VersionedParams(&amp;api.ListOptions&#123;ResourceVersion: <span class="string">"0"</span>&#125;, api.ParameterCodec).</span><br><span class="line">	FieldsSelectorParam(fields.Everything()).</span><br><span class="line">	Do().</span><br><span class="line">	Get()</span><br></pre></td></tr></table></figure>
<p>在创建client的时候我们设置了http代理，这里我用了fiddler工具用于抓取http的请求内容。接着我们请求了default名称空间下的ingresses资源列表，设置了resourceVersion为0<br>在fiddler中我们发现其请求了/apis/extensions/v1beta1/namespaces/default/ingresses?resourceVersion=0这个api<br>并且返回了一下的内容<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"kind"</span>: <span class="string">"IngressList"</span>,</span><br><span class="line">  <span class="attr">"apiVersion"</span>: <span class="string">"extensions/v1beta1"</span>,</span><br><span class="line">  <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">    <span class="attr">"selfLink"</span>: <span class="string">"/apis/extensions/v1beta1/namespaces/default/ingresses"</span>,</span><br><span class="line">    <span class="attr">"resourceVersion"</span>: <span class="string">"2264497"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"items"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"nginx-test"</span>,</span><br><span class="line">        <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="attr">"selfLink"</span>: <span class="string">"/apis/extensions/v1beta1/namespaces/default/ingresses/nginx-test"</span>,</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"fa01f640-231f-11e7-b7f6-ecf4bbc532cc"</span>,</span><br><span class="line">        <span class="attr">"resourceVersion"</span>: <span class="string">"2264486"</span>,</span><br><span class="line">        <span class="attr">"generation"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"creationTimestamp"</span>: <span class="string">"2017-04-17T03:43:10Z"</span>,</span><br><span class="line">        <span class="attr">"annotations"</span>: &#123;</span><br><span class="line">          <span class="attr">"ingress.kubernetes.io/force-ssl-redirect"</span>: <span class="string">"false"</span>,</span><br><span class="line">          <span class="attr">"kubernetes.io/ingress.class"</span>: <span class="string">"nginx"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"spec"</span>: &#123;</span><br><span class="line">        <span class="attr">"rules"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"host"</span>: <span class="string">"stickyingress.example.com"</span>,</span><br><span class="line">            <span class="attr">"http"</span>: &#123;</span><br><span class="line">              <span class="attr">"paths"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">"path"</span>: <span class="string">"/"</span>,</span><br><span class="line">                  <span class="attr">"backend"</span>: &#123;</span><br><span class="line">                    <span class="attr">"serviceName"</span>: <span class="string">"echoheaders-x"</span>,</span><br><span class="line">                    <span class="attr">"servicePort"</span>: <span class="number">80</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"status"</span>: &#123;</span><br><span class="line">        <span class="attr">"loadBalancer"</span>: &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"yangz-lb-test"</span>,</span><br><span class="line">        <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="attr">"selfLink"</span>: <span class="string">"/apis/extensions/v1beta1/namespaces/default/ingresses/yangz-lb-test"</span>,</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"fef1d670-231f-11e7-b7f6-ecf4bbc532cc"</span>,</span><br><span class="line">        <span class="attr">"resourceVersion"</span>: <span class="string">"2264497"</span>,</span><br><span class="line">        <span class="attr">"generation"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"creationTimestamp"</span>: <span class="string">"2017-04-17T03:43:18Z"</span>,</span><br><span class="line">        <span class="attr">"annotations"</span>: &#123;</span><br><span class="line">          <span class="attr">"ingress.kubernetes.io/force-ssl-redirect"</span>: <span class="string">"false"</span>,</span><br><span class="line">          <span class="attr">"kubernetes.io/ingress.class"</span>: <span class="string">"nginx"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"spec"</span>: &#123;</span><br><span class="line">        <span class="attr">"rules"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"host"</span>: <span class="string">"www.yangz.com"</span>,</span><br><span class="line">            <span class="attr">"http"</span>: &#123;</span><br><span class="line">              <span class="attr">"paths"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">"path"</span>: <span class="string">"/"</span>,</span><br><span class="line">                  <span class="attr">"backend"</span>: &#123;</span><br><span class="line">                    <span class="attr">"serviceName"</span>: <span class="string">"yangz-lb-test"</span>,</span><br><span class="line">                    <span class="attr">"servicePort"</span>: <span class="number">80</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"status"</span>: &#123;</span><br><span class="line">        <span class="attr">"loadBalancer"</span>: &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这段json列出了当前default名称空间下的所有ingress资源的情况。有了这些列表数据（可以使用同样的方法列出service,node,secret等其它资源），对于我们生成backend的配置（如nginx的配置）就已经足够了，我们可以通过不停的轮询这个接口，一旦发现数据发生了变化，我们就重新生成配置并加载它。一切工作到这里似乎就可以结束了，但是细心的读者可能会发生我们还有一watch接口。这里要记住list接口返回的resourceVersion:2264497</p>
<h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">watch, err := kubeClient.Extensions().RESTClient().</span><br><span class="line">		Get().</span><br><span class="line">		Prefix(<span class="string">"watch"</span>).</span><br><span class="line">		Namespace(<span class="string">"default"</span>).</span><br><span class="line">		Resource(<span class="string">"ingresses"</span>).</span><br><span class="line">		VersionedParams(&amp;api.ListOptions&#123;ResourceVersion: <span class="string">"2264497"</span>&#125;, api.ParameterCodec).</span><br><span class="line">		FieldsSelectorParam(fields.Everything()).</span><br><span class="line">		Watch()</span><br></pre></td></tr></table></figure>
<p>通过fiddler可以看到请求了/apis/extensions/v1beta1/watch/namespaces/default/ingresses?resourceVersion=2264497这个接口，值得注意的是在返回的http头是这样子的<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/vnd.kubernetes.protobuf;stream=watch</span><br><span class="line">Date: Mon, 17 Apr 2017 03:54:47 GMT</span><br><span class="line">Transfer-Encoding: chunked</span><br></pre></td></tr></table></figure></p>
<p>这个时候这个http请求是没有Content-Lenth头，而且服务端一直hold住这个请求，注意Transfer-Encoding: chunked。对于http服务端主动通知客户端的，除了轮询外，还有使用这种方式的，这也是大多数web聊天工具使用的方式。<br>这时候我们发现通过resourceVersion=2264497请求不到任何的东西，这是因为对于2264497这个版本号来说，当前ingress资源并没有发生任何变化<br>我们再做以下实验:在master机上运行kubectl delete -n default ing –all<br>这个命令删除default名称空间下面的所有ingress资源，这时候可以发下刚才hold住的http请求立即返回了一些信息：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"DELETED"</span>,</span><br><span class="line">    <span class="attr">"object"</span>: &#123;</span><br><span class="line">        <span class="attr">"kind"</span>: <span class="string">"Ingress"</span>,</span><br><span class="line">        <span class="attr">"apiVersion"</span>: <span class="string">"extensions/v1beta1"</span>,</span><br><span class="line">        <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"nginx-test"</span>,</span><br><span class="line">            <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="attr">"selfLink"</span>: <span class="string">"/apis/extensions/v1beta1/namespaces/default/ingresses/nginx-test"</span>,</span><br><span class="line">            <span class="attr">"uid"</span>: <span class="string">"fa01f640-231f-11e7-b7f6-ecf4bbc532cc"</span>,</span><br><span class="line">            <span class="attr">"resourceVersion"</span>: <span class="string">"2273842"</span>,</span><br><span class="line">            <span class="attr">"generation"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"creationTimestamp"</span>: <span class="string">"2017-04-17T03:43:10Z"</span>,</span><br><span class="line">            <span class="attr">"annotations"</span>: &#123;</span><br><span class="line">                <span class="attr">"ingress.kubernetes.io/force-ssl-redirect"</span>: <span class="string">"false"</span>,</span><br><span class="line">                <span class="attr">"kubernetes.io/ingress.class"</span>: <span class="string">"nginx"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"spec"</span>: &#123;</span><br><span class="line">            <span class="attr">"rules"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"host"</span>: <span class="string">"stickyingress.example.com"</span>,</span><br><span class="line">                    <span class="attr">"http"</span>: &#123;</span><br><span class="line">                        <span class="attr">"paths"</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"path"</span>: <span class="string">"/"</span>,</span><br><span class="line">                                <span class="attr">"backend"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"serviceName"</span>: <span class="string">"echoheaders-x"</span>,</span><br><span class="line">                                    <span class="attr">"servicePort"</span>: <span class="number">80</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"status"</span>: &#123;</span><br><span class="line">            <span class="attr">"loadBalancer"</span>: &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"DELETED"</span>,</span><br><span class="line">    <span class="attr">"object"</span>: &#123;</span><br><span class="line">        <span class="attr">"kind"</span>: <span class="string">"Ingress"</span>,</span><br><span class="line">        <span class="attr">"apiVersion"</span>: <span class="string">"extensions/v1beta1"</span>,</span><br><span class="line">        <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"yangz-lb-test"</span>,</span><br><span class="line">            <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="attr">"selfLink"</span>: <span class="string">"/apis/extensions/v1beta1/namespaces/default/ingresses/yangz-lb-test"</span>,</span><br><span class="line">            <span class="attr">"uid"</span>: <span class="string">"fef1d670-231f-11e7-b7f6-ecf4bbc532cc"</span>,</span><br><span class="line">            <span class="attr">"resourceVersion"</span>: <span class="string">"2273843"</span>,</span><br><span class="line">            <span class="attr">"generation"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"creationTimestamp"</span>: <span class="string">"2017-04-17T03:43:18Z"</span>,</span><br><span class="line">            <span class="attr">"annotations"</span>: &#123;</span><br><span class="line">                <span class="attr">"ingress.kubernetes.io/force-ssl-redirect"</span>: <span class="string">"false"</span>,</span><br><span class="line">                <span class="attr">"kubernetes.io/ingress.class"</span>: <span class="string">"nginx"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"spec"</span>: &#123;</span><br><span class="line">            <span class="attr">"rules"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"host"</span>: <span class="string">"www.yangz.com"</span>,</span><br><span class="line">                    <span class="attr">"http"</span>: &#123;</span><br><span class="line">                        <span class="attr">"paths"</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"path"</span>: <span class="string">"/"</span>,</span><br><span class="line">                                <span class="attr">"backend"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"serviceName"</span>: <span class="string">"yangz-lb-test"</span>,</span><br><span class="line">                                    <span class="attr">"servicePort"</span>: <span class="number">80</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"status"</span>: &#123;</span><br><span class="line">            <span class="attr">"loadBalancer"</span>: &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>json显示了我们所删掉的ingress资源信息，注意其中的resourceVersion，这个时候我们修改watch接口中的resourceVersion为2273842的话，那么其返回内容会变成<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"DELETED"</span>,</span><br><span class="line">    <span class="attr">"object"</span>: &#123;</span><br><span class="line">        <span class="attr">"kind"</span>: <span class="string">"Ingress"</span>,</span><br><span class="line">        <span class="attr">"apiVersion"</span>: <span class="string">"extensions/v1beta1"</span>,</span><br><span class="line">        <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"yangz-lb-test"</span>,</span><br><span class="line">            <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="attr">"selfLink"</span>: <span class="string">"/apis/extensions/v1beta1/namespaces/default/ingresses/yangz-lb-test"</span>,</span><br><span class="line">            <span class="attr">"uid"</span>: <span class="string">"fef1d670-231f-11e7-b7f6-ecf4bbc532cc"</span>,</span><br><span class="line">            <span class="attr">"resourceVersion"</span>: <span class="string">"2273843"</span>,</span><br><span class="line">            <span class="attr">"generation"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"creationTimestamp"</span>: <span class="string">"2017-04-17T03:43:18Z"</span>,</span><br><span class="line">            <span class="attr">"annotations"</span>: &#123;</span><br><span class="line">                <span class="attr">"ingress.kubernetes.io/force-ssl-redirect"</span>: <span class="string">"false"</span>,</span><br><span class="line">                <span class="attr">"kubernetes.io/ingress.class"</span>: <span class="string">"nginx"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"spec"</span>: &#123;</span><br><span class="line">            <span class="attr">"rules"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"host"</span>: <span class="string">"www.yangz.com"</span>,</span><br><span class="line">                    <span class="attr">"http"</span>: &#123;</span><br><span class="line">                        <span class="attr">"paths"</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"path"</span>: <span class="string">"/"</span>,</span><br><span class="line">                                <span class="attr">"backend"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"serviceName"</span>: <span class="string">"yangz-lb-test"</span>,</span><br><span class="line">                                    <span class="attr">"servicePort"</span>: <span class="number">80</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"status"</span>: &#123;</span><br><span class="line">            <span class="attr">"loadBalancer"</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是说，watch接口根据请求的版本号返回当前服务器的状态与给定版本之间的差异。例如在版本2264497和2273843之间，有两个ingress被删除，而2273842和2273843这两个版本之间只有一个ingress被删除。</p>
<p>小结：listwatch在初始化的时候先通过list接口获取当前资源的列表以及resourceVersion，接着再通过watch接口监听资源的变化。</p>
<h2 id="事件的传递"><a href="#事件的传递" class="headerlink" title="事件的传递"></a>事件的传递</h2><p>了解了资源的监听机制，那么程序是在什么时候开始监听的，并且发生变化后事件是如何传递的呢？<br>在上文件的NewInformer函数返回了两个值:cache.Store和cache.Controller，其中Controller在GenericController的Start方法中被用到<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ic GenericController)</span> <span class="title">Start</span><span class="params">()</span></span> &#123;</span><br><span class="line">	glog.Infof(<span class="string">"starting Ingress controller"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> ic.ingController.Run(ic.stopCh)</span><br><span class="line">	<span class="keyword">go</span> ic.endpController.Run(ic.stopCh)</span><br><span class="line">	<span class="keyword">go</span> ic.svcController.Run(ic.stopCh)</span><br><span class="line">	<span class="keyword">go</span> ic.nodeController.Run(ic.stopCh)</span><br><span class="line">	<span class="keyword">go</span> ic.secrController.Run(ic.stopCh)</span><br><span class="line">	<span class="keyword">go</span> ic.mapController.Run(ic.stopCh)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> ic.secretQueue.Run(<span class="number">5</span>*time.Second, ic.stopCh)</span><br><span class="line">	<span class="keyword">go</span> ic.syncQueue.Run(<span class="number">5</span>*time.Second, ic.stopCh)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ic.syncStatus != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">go</span> ic.syncStatus.Run(ic.stopCh)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&lt;-ic.stopCh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法就是在文章开头的main函数中被调用到的ic.Start方法,这里可以看到有6个controller，分别对应了6种资源:ingresses,endpoints,services,nodes,secrets,configmaps。在调用cache.Controller的Run方法时，每个Controller都会开始ListWatch流程，对相应的资源进行监听。</p>
<p>看一下Run方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> utilruntime.HandleCrash()</span><br><span class="line">	r := NewReflector(</span><br><span class="line">		c.config.ListerWatcher,</span><br><span class="line">		c.config.ObjectType,</span><br><span class="line">		c.config.Queue,</span><br><span class="line">		c.config.FullResyncPeriod,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	c.reflectorMutex.Lock()</span><br><span class="line">	c.reflector = r</span><br><span class="line">	c.reflectorMutex.Unlock()</span><br><span class="line"></span><br><span class="line">	r.RunUntil(stopCh)</span><br><span class="line"></span><br><span class="line">	wait.Until(c.processLoop, time.Second, stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际运行是通过Reflector的RunUntil<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reflector)</span> <span class="title">RunUntil</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	glog.V(<span class="number">3</span>).Infof(<span class="string">"Starting reflector %v (%s) from %s"</span>, r.expectedType, r.resyncPeriod, r.name)</span><br><span class="line">	<span class="keyword">go</span> wait.Until(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := r.ListAndWatch(stopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			utilruntime.HandleError(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, r.period, stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Until loops until stop channel is closed, running f every period.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Until is syntactic sugar on top of JitterUntil with zero jitter factor and</span></span><br><span class="line"><span class="comment">// with sliding = true (which means the timer for period starts after the f</span></span><br><span class="line"><span class="comment">// completes).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Until</span><span class="params">(f <span class="keyword">func</span>()</span>, <span class="title">period</span> <span class="title">time</span>.<span class="title">Duration</span>, <span class="title">stopCh</span> &lt;-<span class="title">chan</span> <span class="title">struct</span></span>&#123;&#125;) &#123;</span><br><span class="line">	JitterUntil(f, period, <span class="number">0.0</span>, <span class="literal">true</span>, stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释里面说到，Until循环调用f函数，每隔period时长调用一次，直到stop channel被关闭。可以看到这个period参数是在应用程序启动的时候通过命令行参数指定的，如果不指定，则默认值为60s<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">resyncPeriod = flags.Duration(<span class="string">"sync-period"</span>, <span class="number">60</span>*time.Second,</span><br><span class="line">			<span class="string">`Relist and confirm cloud resources this often.`</span>)</span><br></pre></td></tr></table></figure></p>
<p>笔者猜测，这么做的目的应该是防止watch的时候http连接异常断开之后导致后续的监听失效，毕竟http无法保证连接的稳定性。</p>
<p>那么真正干活的地方应该就是Reflactor的ListAndWatch方法了<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ListAndWatch first lists all items and get the resource version at the moment of call,</span></span><br><span class="line"><span class="comment">// and then use the resource version to watch.</span></span><br><span class="line"><span class="comment">// It returns error if ListAndWatch didn't even try to initialize watch.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reflector)</span> <span class="title">ListAndWatch</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	glog.V(<span class="number">3</span>).Infof(<span class="string">"Listing and watching %v from %s"</span>, r.expectedType, r.name)</span><br><span class="line">	<span class="keyword">var</span> resourceVersion <span class="keyword">string</span></span><br><span class="line">	resyncCh, cleanup := r.resyncChan()</span><br><span class="line">	<span class="keyword">defer</span> cleanup()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Explicitly set "0" as resource version - it's fine for the List()</span></span><br><span class="line">	<span class="comment">// to be served from cache and potentially be delayed relative to</span></span><br><span class="line">	<span class="comment">// etcd contents. Reflector framework will catch up via Watch() eventually.</span></span><br><span class="line">	options := api.ListOptions&#123;ResourceVersion: <span class="string">"0"</span>&#125;</span><br><span class="line">	list, err := r.listerWatcher.List(options)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s: Failed to list %v: %v"</span>, r.name, r.expectedType, err)</span><br><span class="line">	&#125;</span><br><span class="line">	listMetaInterface, err := meta.ListAccessor(list)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s: Unable to understand list result %#v: %v"</span>, r.name, list, err)</span><br><span class="line">	&#125;</span><br><span class="line">	resourceVersion = listMetaInterface.GetResourceVersion()</span><br><span class="line">	items, err := meta.ExtractList(list)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s: Unable to understand list result %#v (%v)"</span>, r.name, list, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := r.syncWith(items, resourceVersion); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"%s: Unable to sync list result: %v"</span>, r.name, err)</span><br><span class="line">	&#125;</span><br><span class="line">	r.setLastSyncResourceVersion(resourceVersion)</span><br><span class="line"></span><br><span class="line">	resyncerrc := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</span><br><span class="line">	cancelCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">defer</span> <span class="built_in">close</span>(cancelCh)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> &lt;-resyncCh:</span><br><span class="line">			<span class="keyword">case</span> &lt;-stopCh:</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			<span class="keyword">case</span> &lt;-cancelCh:</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			glog.V(<span class="number">4</span>).Infof(<span class="string">"%s: forcing resync"</span>, r.name)</span><br><span class="line">			<span class="keyword">if</span> err := r.store.Resync(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				resyncerrc &lt;- err</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			cleanup()</span><br><span class="line">			resyncCh, cleanup = r.resyncChan()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		timemoutseconds := <span class="keyword">int64</span>(minWatchTimeout.Seconds() * (rand.Float64() + <span class="number">1.0</span>))</span><br><span class="line">		options = api.ListOptions&#123;</span><br><span class="line">			ResourceVersion: resourceVersion,</span><br><span class="line">			<span class="comment">// We want to avoid situations of hanging watchers. Stop any wachers that do not</span></span><br><span class="line">			<span class="comment">// receive any events within the timeout window.</span></span><br><span class="line">			TimeoutSeconds: &amp;timemoutseconds,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		w, err := r.listerWatcher.Watch(options)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">switch</span> err &#123;</span><br><span class="line">			<span class="keyword">case</span> io.EOF:</span><br><span class="line">				<span class="comment">// watch closed normally</span></span><br><span class="line">			<span class="keyword">case</span> io.ErrUnexpectedEOF:</span><br><span class="line">				glog.V(<span class="number">1</span>).Infof(<span class="string">"%s: Watch for %v closed with unexpected EOF: %v"</span>, r.name, r.expectedType, err)</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				utilruntime.HandleError(fmt.Errorf(<span class="string">"%s: Failed to watch %v: %v"</span>, r.name, r.expectedType, err))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// If this is "connection refused" error, it means that most likely apiserver is not responsive.</span></span><br><span class="line">			<span class="comment">// It doesn't make sense to re-list all objects because most likely we will be able to restart</span></span><br><span class="line">			<span class="comment">// watch where we ended.</span></span><br><span class="line">			<span class="comment">// If that's the case wait and resend watch request.</span></span><br><span class="line">			<span class="keyword">if</span> urlError, ok := err.(*url.Error); ok &#123;</span><br><span class="line">				<span class="keyword">if</span> opError, ok := urlError.Err.(*net.OpError); ok &#123;</span><br><span class="line">					<span class="keyword">if</span> errno, ok := opError.Err.(syscall.Errno); ok &amp;&amp; errno == syscall.ECONNREFUSED &#123;</span><br><span class="line">						time.Sleep(time.Second)</span><br><span class="line">						<span class="keyword">continue</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := r.watchHandler(w, &amp;resourceVersion, resyncerrc, stopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err != errorStopRequested &#123;</span><br><span class="line">				glog.Warningf(<span class="string">"%s: watch of %v ended with: %v"</span>, r.name, r.expectedType, err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于watch资源的处理方法：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// watchHandler watches w and keeps *resourceVersion up to date.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reflector)</span> <span class="title">watchHandler</span><span class="params">(w watch.Interface, resourceVersion *<span class="keyword">string</span>, errc <span class="keyword">chan</span> error, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	start := time.Now()</span><br><span class="line">	eventCount := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Stopping the watcher should be idempotent and if we return from this function there's no way</span></span><br><span class="line">	<span class="comment">// we're coming back in with the same watch interface.</span></span><br><span class="line">	<span class="keyword">defer</span> w.Stop()</span><br><span class="line"></span><br><span class="line">loop:</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-stopCh:</span><br><span class="line">			<span class="keyword">return</span> errorStopRequested</span><br><span class="line">		<span class="keyword">case</span> err := &lt;-errc:</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		<span class="keyword">case</span> event, ok := &lt;-w.ResultChan():</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="keyword">break</span> loop</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> event.Type == watch.Error &#123;</span><br><span class="line">				<span class="keyword">return</span> apierrs.FromObject(event.Object)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> e, a := r.expectedType, reflect.TypeOf(event.Object); e != <span class="literal">nil</span> &amp;&amp; e != a &#123;</span><br><span class="line">				utilruntime.HandleError(fmt.Errorf(<span class="string">"%s: expected type %v, but watch event object had type %v"</span>, r.name, e, a))</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			meta, err := meta.Accessor(event.Object)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				utilruntime.HandleError(fmt.Errorf(<span class="string">"%s: unable to understand watch event %#v"</span>, r.name, event))</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			newResourceVersion := meta.GetResourceVersion()</span><br><span class="line">			<span class="keyword">switch</span> event.Type &#123;</span><br><span class="line">			<span class="keyword">case</span> watch.Added:</span><br><span class="line">				r.store.Add(event.Object)</span><br><span class="line">			<span class="keyword">case</span> watch.Modified:</span><br><span class="line">				r.store.Update(event.Object)</span><br><span class="line">			<span class="keyword">case</span> watch.Deleted:</span><br><span class="line">				<span class="comment">// <span class="doctag">TODO:</span> Will any consumers need access to the "last known</span></span><br><span class="line">				<span class="comment">// state", which is passed in event.Object? If so, may need</span></span><br><span class="line">				<span class="comment">// to change this.</span></span><br><span class="line">				r.store.Delete(event.Object)</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				utilruntime.HandleError(fmt.Errorf(<span class="string">"%s: unable to understand watch event %#v"</span>, r.name, event))</span><br><span class="line">			&#125;</span><br><span class="line">			*resourceVersion = newResourceVersion</span><br><span class="line">			r.setLastSyncResourceVersion(newResourceVersion)</span><br><span class="line">			eventCount++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	watchDuration := time.Now().Sub(start)</span><br><span class="line">	<span class="keyword">if</span> watchDuration &lt; <span class="number">1</span>*time.Second &amp;&amp; eventCount == <span class="number">0</span> &#123;</span><br><span class="line">		glog.V(<span class="number">4</span>).Infof(<span class="string">"%s: Unexpected watch close - watch lasted less than a second and no items received"</span>, r.name)</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"very short watch"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	glog.V(<span class="number">4</span>).Infof(<span class="string">"%s: Watch close - %v total %v items received"</span>, r.name, r.expectedType, eventCount)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里发现资源变化的时候，是通过cache.Store这样一个接口来存储变化的<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Store <span class="keyword">interface</span> &#123;</span><br><span class="line">	Add(obj <span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">	Update(obj <span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">	Delete(obj <span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">	List() []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	ListKeys() []<span class="keyword">string</span></span><br><span class="line">	Get(obj <span class="keyword">interface</span>&#123;&#125;) (item <span class="keyword">interface</span>&#123;&#125;, exists <span class="keyword">bool</span>, err error)</span><br><span class="line">	GetByKey(key <span class="keyword">string</span>) (item <span class="keyword">interface</span>&#123;&#125;, exists <span class="keyword">bool</span>, err error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Replace will delete the contents of the store, using instead the</span></span><br><span class="line">	<span class="comment">// given list. Store takes ownership of the list, you should not reference</span></span><br><span class="line">	<span class="comment">// it after calling this function.</span></span><br><span class="line">	Replace([]<span class="keyword">interface</span>&#123;&#125;, <span class="keyword">string</span>) error</span><br><span class="line">	Resync() error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个Store是在NewInformer的时候初始化的<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fifo := NewDeltaFIFO(MetaNamespaceKeyFunc, <span class="literal">nil</span>, clientState)</span><br></pre></td></tr></table></figure></p>
<p>并且在cache.Controller调用Run的时候，开始对该队列进行监听<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wait.Until(c.processLoop, time.Second, stopCh)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">processLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		obj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> c.config.RetryOnError &#123;</span><br><span class="line">				<span class="comment">// This is the safe way to re-enqueue.</span></span><br><span class="line">				c.config.Queue.AddIfNotPresent(obj)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样c.config.Process也是在NewInformer的时候定义的：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Process: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			<span class="comment">// from oldest to newest</span></span><br><span class="line">			<span class="keyword">for</span> _, d := <span class="keyword">range</span> obj.(Deltas) &#123;</span><br><span class="line">				<span class="keyword">switch</span> d.Type &#123;</span><br><span class="line">				<span class="keyword">case</span> Sync, Added, Updated:</span><br><span class="line">					<span class="keyword">if</span> old, exists, err := clientState.Get(d.Object); err == <span class="literal">nil</span> &amp;&amp; exists &#123;</span><br><span class="line">						<span class="keyword">if</span> err := clientState.Update(d.Object); err != <span class="literal">nil</span> &#123;</span><br><span class="line">							<span class="keyword">return</span> err</span><br><span class="line">						&#125;</span><br><span class="line">						h.OnUpdate(old, d.Object)</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> err := clientState.Add(d.Object); err != <span class="literal">nil</span> &#123;</span><br><span class="line">							<span class="keyword">return</span> err</span><br><span class="line">						&#125;</span><br><span class="line">						h.OnAdd(d.Object)</span><br><span class="line">					&#125;</span><br><span class="line">				<span class="keyword">case</span> Deleted:</span><br><span class="line">					<span class="keyword">if</span> err := clientState.Delete(d.Object); err != <span class="literal">nil</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> err</span><br><span class="line">					&#125;</span><br><span class="line">					h.OnDelete(d.Object)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的h就是上文提到的ResourceEventHandler接口。当资源发化变化时，会先将资源保存到本地缓存中，再触发对应的事件，这里将资源缓存起来，以便后续的程序可以直接取，不用再次请求服务端。</p>
<p>这里简单看一下对于ingress资源发生变动时相应的处理逻辑:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">ingEventHandler := cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">		AddFunc: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			addIng := obj.(*extensions.Ingress)</span><br><span class="line">			<span class="keyword">if</span> !class.IsValid(addIng, ic.cfg.IngressClass, ic.cfg.DefaultIngressClass) &#123;</span><br><span class="line">				glog.Infof(<span class="string">"ignoring add for ingress %v based on annotation %v"</span>, addIng.Name, class.IngressKey)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			ic.recorder.Eventf(addIng, api.EventTypeNormal, <span class="string">"CREATE"</span>, fmt.Sprintf(<span class="string">"Ingress %s/%s"</span>, addIng.Namespace, addIng.Name))</span><br><span class="line">			ic.syncQueue.Enqueue(obj)</span><br><span class="line">			<span class="keyword">if</span> ic.annotations.ContainsCertificateAuth(addIng) &#123;</span><br><span class="line">				s, err := ic.annotations.CertificateAuthSecret(addIng)</span><br><span class="line">				<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">					ic.secretQueue.Enqueue(s)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		DeleteFunc: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			delIng := obj.(*extensions.Ingress)</span><br><span class="line">			<span class="keyword">if</span> !class.IsValid(delIng, ic.cfg.IngressClass, ic.cfg.DefaultIngressClass) &#123;</span><br><span class="line">				glog.Infof(<span class="string">"ignoring delete for ingress %v based on annotation %v"</span>, delIng.Name, class.IngressKey)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			ic.recorder.Eventf(delIng, api.EventTypeNormal, <span class="string">"DELETE"</span>, fmt.Sprintf(<span class="string">"Ingress %s/%s"</span>, delIng.Namespace, delIng.Name))</span><br><span class="line">			ic.syncQueue.Enqueue(obj)</span><br><span class="line">		&#125;,</span><br><span class="line">		UpdateFunc: <span class="function"><span class="keyword">func</span><span class="params">(old, cur <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			oldIng := old.(*extensions.Ingress)</span><br><span class="line">			curIng := cur.(*extensions.Ingress)</span><br><span class="line">			<span class="keyword">if</span> !class.IsValid(curIng, ic.cfg.IngressClass, ic.cfg.DefaultIngressClass) &amp;&amp;</span><br><span class="line">				!class.IsValid(oldIng, ic.cfg.IngressClass, ic.cfg.DefaultIngressClass) &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> !reflect.DeepEqual(old, cur) &#123;</span><br><span class="line">				upIng := cur.(*extensions.Ingress)</span><br><span class="line">				ic.recorder.Eventf(upIng, api.EventTypeNormal, <span class="string">"UPDATE"</span>, fmt.Sprintf(<span class="string">"Ingress %s/%s"</span>, upIng.Namespace, upIng.Name))</span><br><span class="line">				<span class="comment">// the referenced secret is different?</span></span><br><span class="line">				<span class="keyword">if</span> diff := pretty.Compare(curIng.Spec.TLS, oldIng.Spec.TLS); diff != <span class="string">""</span> &#123;</span><br><span class="line">					<span class="keyword">for</span> _, secretName := <span class="keyword">range</span> curIng.Spec.TLS &#123;</span><br><span class="line">						secKey := <span class="string">""</span></span><br><span class="line">						<span class="keyword">if</span> secretName.SecretName != <span class="string">""</span> &#123;</span><br><span class="line">							secKey = fmt.Sprintf(<span class="string">"%v/%v"</span>, curIng.Namespace, secretName.SecretName)</span><br><span class="line">						&#125;</span><br><span class="line">						glog.Infof(<span class="string">"TLS section in ingress %v/%v changed (secret is now \"%v\")"</span>, upIng.Namespace, upIng.Name, secKey)</span><br><span class="line">						<span class="comment">// default cert is already queued</span></span><br><span class="line">						<span class="keyword">if</span> secKey != <span class="string">""</span> &#123;</span><br><span class="line">							<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">								<span class="comment">// we need to wait until the ingress store is updated</span></span><br><span class="line">								time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">								key, err := ic.GetSecret(secKey)</span><br><span class="line">								<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">									glog.Errorf(<span class="string">"unexpected error: %v"</span>, err)</span><br><span class="line">								&#125;</span><br><span class="line">								<span class="keyword">if</span> key != <span class="literal">nil</span> &#123;</span><br><span class="line">									ic.secretQueue.Enqueue(key)</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;()</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> ic.annotations.ContainsCertificateAuth(upIng) &#123;</span><br><span class="line">					s, err := ic.annotations.CertificateAuthSecret(upIng)</span><br><span class="line">					<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">						ic.secretQueue.Enqueue(s)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				ic.syncQueue.Enqueue(cur)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要处理的就是对ingress资源的tsl节点，如果发现了对应的tsl资源，则会对secretQueue进行Enqueue操作。</p>
<p>到这里，整个框架的来龙去脉就基本上理清楚了，现在回到这两个队列上面:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ic.syncQueue = task.NewTaskQueue(ic.sync)</span><br><span class="line">ic.secretQueue = task.NewTaskQueue(ic.syncSecret)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ic *GenericController)</span> <span class="title">sync</span><span class="params">(e <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	ic.syncRateLimiter.Accept()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ic.syncQueue.IsShuttingDown() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !ic.controllersInSync() &#123;</span><br><span class="line">		time.Sleep(podStoreSyncedPollPeriod)</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"deferring sync till endpoints controller has synced"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	upstreams, servers := ic.getBackendServers()</span><br><span class="line">	<span class="keyword">var</span> passUpstreams []*ingress.SSLPassthroughBackend</span><br><span class="line">	<span class="keyword">for</span> _, server := <span class="keyword">range</span> servers &#123;</span><br><span class="line">		<span class="keyword">if</span> !server.SSLPassthrough &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> _, loc := <span class="keyword">range</span> server.Locations &#123;</span><br><span class="line">			<span class="keyword">if</span> loc.Path != rootLocation &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			passUpstreams = <span class="built_in">append</span>(passUpstreams, &amp;ingress.SSLPassthroughBackend&#123;</span><br><span class="line">				Backend:  loc.Backend,</span><br><span class="line">				Hostname: server.Hostname,</span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	data, err := ic.cfg.Backend.OnUpdate(ingress.Configuration&#123;</span><br><span class="line">		Backends:            upstreams,</span><br><span class="line">		Servers:             servers,</span><br><span class="line">		TCPEndpoints:        ic.getStreamServices(ic.cfg.TCPConfigMapName, api.ProtocolTCP),</span><br><span class="line">		UDPEndpoints:        ic.getStreamServices(ic.cfg.UDPConfigMapName, api.ProtocolUDP),</span><br><span class="line">		PassthroughBackends: passUpstreams,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	out, reloaded, err := ic.cfg.Backend.Reload(data)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		incReloadErrorCount()</span><br><span class="line">		glog.Errorf(<span class="string">"unexpected failure restarting the backend: \n%v"</span>, <span class="keyword">string</span>(out))</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> reloaded &#123;</span><br><span class="line">		glog.Infof(<span class="string">"ingress backend successfully reloaded..."</span>)</span><br><span class="line">		incReloadCount()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里将一切资源组织成ingress.Configuration结构传给OnUpdate方法，OnUpdate由各个Ingress Controller实现方实现，生成对应的配置数据（例如nginx的config）以byte切片返回，然后再将这些配置数据传给Reload方法，这个方法同样由第三方实现。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文通过分析源码的方式理清了整个Ingress Controller框架的来龙去脉，在下一篇文章中，通过对Nginx Ingress Controller源码分析，来看一下如何实现一个Ingress Controller。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/04/13/KubernetesIngress（1）/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Kubernetes Ingress（1）简介
        
      </div>
    </a>
  
  
    <a href="/2017/03/20/centos7-kubernetes-deploy/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">centos7-kubernetes-deploy</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="KubernetesIngress（2）" data-title="Kubernetes Ingress（2）Controller源码分析" data-url="http://yoursite.com/2017/04/13/KubernetesIngress（2）/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2019 Dockerfun
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>